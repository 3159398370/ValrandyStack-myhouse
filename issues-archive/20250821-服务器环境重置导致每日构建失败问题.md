# 2025-08-21 æœåŠ¡å™¨ç¯å¢ƒé‡ç½®å¯¼è‡´æ¯æ—¥æ„å»ºå¤±è´¥é—®é¢˜

## ğŸš¨ é—®é¢˜å‡çº§

**å‘ç”Ÿæ—¶é—´**: 2025-08-21 08:04:05
**é—®é¢˜æœ¬è´¨**: æœåŠ¡å™¨æ¯æ—¥è‡ªåŠ¨é‡ç½®ç¯å¢ƒ
**ç³»ç»Ÿç±»å‹**: CentOS/RHEL (éDebian)
**å½±å“**: node_moduleså’Œæ„å»ºäº§ç‰©æ¯æ—¥ä¸¢å¤±

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

1. **æœåŠ¡å™¨ç¯å¢ƒæ¯æ—¥é‡ç½®**
   - å¯èƒ½æ˜¯å®¹å™¨åŒ–ç¯å¢ƒ
   - å¯èƒ½æ˜¯ä¸´æ—¶æ–‡ä»¶ç³»ç»Ÿ
   - å¯èƒ½æ˜¯ç³»ç»Ÿé‡å¯ç­–ç•¥

2. **Node.jsç‰ˆæœ¬è¿‡ä½**
   - å½“å‰: v16.20.2
   - éœ€è¦: >=20.x
   - ç³»ç»Ÿ: CentOS/RHEL

3. **ä¾èµ–ç®¡ç†é—®é¢˜**
   - æ¯æ—¥éœ€è¦é‡æ–°å®‰è£…
   - æ„å»ºäº§ç‰©ä¸æŒä¹…

## âœ… CentOS/RHELä¸“ç”¨è§£å†³æ–¹æ¡ˆ

### 1. å‡çº§Node.js (CentOS/RHEL)
```bash
# æ£€æŸ¥å½“å‰ç³»ç»Ÿ
cat /etc/os-release

# CentOS/RHELå‡çº§Node.js
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# æˆ–è€…ä½¿ç”¨dnf (æ–°ç³»ç»Ÿ)
sudo dnf install -y nodejs

# éªŒè¯å‡çº§
node --version
npm --version
```

### 2. ä½¿ç”¨NVMç®¡ç†Nodeç‰ˆæœ¬
```bash
# å®‰è£…NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# å®‰è£…å¹¶ä½¿ç”¨Node 20
nvm install 20
nvm use 20
nvm alias default 20
```

### 3. åˆ›å»ºæŒä¹…åŒ–éƒ¨ç½²æ–¹æ¡ˆ

#### A. ä½¿ç”¨æŒä¹…åŒ–ç›®å½•
```bash
# åˆ›å»ºæŒä¹…åŒ–ç›®å½•
sudo mkdir -p /opt/myhouse-data
sudo chown $(whoami):$(whoami) /opt/myhouse-data

# åˆ›å»ºç¬¦å·é“¾æ¥
ln -sf /opt/myhouse-data/node_modules /www/wwwroot/learningtree.fun/frontend/node_modules
ln -sf /opt/myhouse-data/dist /www/wwwroot/learningtree.fun/frontend/dist
```

#### B. ä½¿ç”¨PM2å®ˆæŠ¤è¿›ç¨‹
```bash
# å®‰è£…PM2
npm install -g pm2

# åˆ›å»ºå¯åŠ¨è„šæœ¬
cat > /opt/myhouse-data/start.sh << 'EOF'
#!/bin/bash
cd /www/wwwroot/learningtree.fun/frontend

# æ£€æŸ¥node_modules
if [ ! -d "node_modules" ]; then
    npm install
fi

# æ£€æŸ¥dist
if [ ! -d "dist" ]; then
    npm run build
fi

# å¯åŠ¨æœåŠ¡
pm2 start npm --name "myhouse-frontend" -- start
EOF

chmod +x /opt/myhouse-data/start.sh
```

### 4. ç³»ç»ŸæœåŠ¡åŒ– (æ¨è)
```bash
# åˆ›å»ºsystemdæœåŠ¡
sudo tee /etc/systemd/system/myhouse-frontend.service << 'EOF'
[Unit]
Description=MyHouse Frontend Service
After=network.target

[Service]
Type=forking
User=root
WorkingDirectory=/www/wwwroot/learningtree.fun/frontend
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# å¯ç”¨æœåŠ¡
sudo systemctl daemon-reload
sudo systemctl enable myhouse-frontend
sudo systemctl start myhouse-frontend
```

### 5. å¿«é€Ÿä¿®å¤è„šæœ¬
```bash
# åˆ›å»ºä¸€é”®ä¿®å¤è„šæœ¬
cat > /usr/local/bin/fix-daily.sh << 'EOF'
#!/bin/bash
echo "$(date): å¼€å§‹æ¯æ—¥ä¿®å¤..."

# æ£€æŸ¥Node.jsç‰ˆæœ¬
if ! command -v node &> /dev/null; then
    echo "å®‰è£…Node.js..."
    curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
    yum install -y nodejs
fi

cd /www/wwwroot/learningtree.fun/frontend

# æ£€æŸ¥ä¾èµ–
if [ ! -d "node_modules" ]; then
    echo "é‡æ–°å®‰è£…ä¾èµ–..."
    npm install
fi

# æ£€æŸ¥æ„å»º
if [ ! -d "dist" ]; then
    echo "é‡æ–°æ„å»º..."
    npm run build
fi

# é‡å¯æœåŠ¡
systemctl restart nginx
/usr/local/bin/deploy_all_in_one.sh check

echo "$(date): ä¿®å¤å®Œæˆ"
EOF

chmod +x /usr/local/bin/fix-daily.sh
```

## ğŸ“‹ ç«‹å³æ‰§è¡Œæ­¥éª¤

```bash
# 1. å‡çº§Node.js
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
yum install -y nodejs

# 2. åˆ›å»ºæŒä¹…åŒ–æ–¹æ¡ˆ
mkdir -p /opt/myhouse-data
cd /www/wwwroot/learningtree.fun/frontend
npm install
npm run build

# 3. è®¾ç½®ç³»ç»ŸæœåŠ¡
systemctl enable nginx
systemctl restart nginx

# 4. éªŒè¯
/usr/local/bin/deploy_all_in_one.sh check
```

## ğŸ”§ ç›‘æ§å»ºè®®

```bash
# æ·»åŠ åˆ°crontabï¼Œæ¯å¤©æ£€æŸ¥
(crontab -l 2>/dev/null; echo "0 6 * * * /usr/local/bin/fix-daily.sh >> /var/log/myhouse-daily.log 2>&1") | crontab -
```

## ğŸ¯ å…³é”®åŒºåˆ«

| Debian/Ubuntu | CentOS/RHEL |
|---------------|-------------|
| apt-get | yum/dnf |
| debåŒ… | rpmåŒ… |
| /etc/apt/sources.list | /etc/yum.repos.d/ |

## ğŸ“ æ€»ç»“

**é—®é¢˜**: æ¯æ—¥ç¯å¢ƒé‡ç½®
**è§£å†³æ–¹æ¡ˆ**: ç³»ç»ŸæœåŠ¡åŒ– + æŒä¹…åŒ–ç›®å½•
**å…³é”®**: ä½¿ç”¨systemdæœåŠ¡ç¡®ä¿é‡å¯åè‡ªåŠ¨æ¢å¤