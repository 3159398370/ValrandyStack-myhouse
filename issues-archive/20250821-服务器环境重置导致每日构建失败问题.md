# 2025-08-21 服务器环境重置导致每日构建失败问题

## 🚨 问题升级

**发生时间**: 2025-08-21 08:04:05
**问题本质**: 服务器每日自动重置环境
**系统类型**: CentOS/RHEL (非Debian)
**影响**: node_modules和构建产物每日丢失

## 🔍 根本原因分析

1. **服务器环境每日重置**
   - 可能是容器化环境
   - 可能是临时文件系统
   - 可能是系统重启策略

2. **Node.js版本过低**
   - 当前: v16.20.2
   - 需要: >=20.x
   - 系统: CentOS/RHEL

3. **依赖管理问题**
   - 每日需要重新安装
   - 构建产物不持久

## ✅ CentOS/RHEL专用解决方案

### 1. 升级Node.js (CentOS/RHEL)
```bash
# 检查当前系统
cat /etc/os-release

# CentOS/RHEL升级Node.js
curl -fsSL https://rpm.nodesource.com/setup_20.x | sudo bash -
sudo yum install -y nodejs

# 或者使用dnf (新系统)
sudo dnf install -y nodejs

# 验证升级
node --version
npm --version
```

### 2. 使用NVM管理Node版本
```bash
# 安装NVM
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# 安装并使用Node 20
nvm install 20
nvm use 20
nvm alias default 20
```

### 3. 创建持久化部署方案

#### A. 使用持久化目录
```bash
# 创建持久化目录
sudo mkdir -p /opt/myhouse-data
sudo chown $(whoami):$(whoami) /opt/myhouse-data

# 创建符号链接
ln -sf /opt/myhouse-data/node_modules /www/wwwroot/learningtree.fun/frontend/node_modules
ln -sf /opt/myhouse-data/dist /www/wwwroot/learningtree.fun/frontend/dist
```

#### B. 使用PM2守护进程
```bash
# 安装PM2
npm install -g pm2

# 创建启动脚本
cat > /opt/myhouse-data/start.sh << 'EOF'
#!/bin/bash
cd /www/wwwroot/learningtree.fun/frontend

# 检查node_modules
if [ ! -d "node_modules" ]; then
    npm install
fi

# 检查dist
if [ ! -d "dist" ]; then
    npm run build
fi

# 启动服务
pm2 start npm --name "myhouse-frontend" -- start
EOF

chmod +x /opt/myhouse-data/start.sh
```

### 4. 系统服务化 (推荐)
```bash
# 创建systemd服务
sudo tee /etc/systemd/system/myhouse-frontend.service << 'EOF'
[Unit]
Description=MyHouse Frontend Service
After=network.target

[Service]
Type=forking
User=root
WorkingDirectory=/www/wwwroot/learningtree.fun/frontend
ExecStart=/usr/bin/npm start
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

# 启用服务
sudo systemctl daemon-reload
sudo systemctl enable myhouse-frontend
sudo systemctl start myhouse-frontend
```

### 5. 快速修复脚本
```bash
# 创建一键修复脚本
cat > /usr/local/bin/fix-daily.sh << 'EOF'
#!/bin/bash
echo "$(date): 开始每日修复..."

# 检查Node.js版本
if ! command -v node &> /dev/null; then
    echo "安装Node.js..."
    curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
    yum install -y nodejs
fi

cd /www/wwwroot/learningtree.fun/frontend

# 检查依赖
if [ ! -d "node_modules" ]; then
    echo "重新安装依赖..."
    npm install
fi

# 检查构建
if [ ! -d "dist" ]; then
    echo "重新构建..."
    npm run build
fi

# 重启服务
systemctl restart nginx
/usr/local/bin/deploy_all_in_one.sh check

echo "$(date): 修复完成"
EOF

chmod +x /usr/local/bin/fix-daily.sh
```

## 📋 立即执行步骤

```bash
# 1. 升级Node.js
curl -fsSL https://rpm.nodesource.com/setup_20.x | bash -
yum install -y nodejs

# 2. 创建持久化方案
mkdir -p /opt/myhouse-data
cd /www/wwwroot/learningtree.fun/frontend
npm install
npm run build

# 3. 设置系统服务
systemctl enable nginx
systemctl restart nginx

# 4. 验证
/usr/local/bin/deploy_all_in_one.sh check
```

## 🔧 监控建议

```bash
# 添加到crontab，每天检查
(crontab -l 2>/dev/null; echo "0 6 * * * /usr/local/bin/fix-daily.sh >> /var/log/myhouse-daily.log 2>&1") | crontab -
```

## 🎯 关键区别

| Debian/Ubuntu | CentOS/RHEL |
|---------------|-------------|
| apt-get | yum/dnf |
| deb包 | rpm包 |
| /etc/apt/sources.list | /etc/yum.repos.d/ |

## 📝 总结

**问题**: 每日环境重置
**解决方案**: 系统服务化 + 持久化目录
**关键**: 使用systemd服务确保重启后自动恢复